<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Cache-Control" content="no-cache">
<meta http-equiv="Expires" content="0">
<script src="jquery-1.12.4.min.js"></script>
<script>
function getUrlParam(name) {
    var m = {};
    var reg = new RegExp("(^|&)" + name + "=([^&]*)", "g");
    var p = window.location.search.substr(1);
    var r = p.match(reg);
    if (r != null) {
        r.forEach(i => {
            var v = unescape(i).substr(i.indexOf("=") + 1);
            console.log(name, v);
            m[v] = '';
        });
        return m;
    }
    return m;
}
var player = '';
var result = {"0":0, "1":0};
var time = 0;
var hero = {};
function getRecord(item, succ, min, x0, x1, y0, y1) {
    if (item[3] == 0 || item[0] != succ || item[4] < min) {
        return '';
    }   
    player = item[1];
    var str = '';
    //str += '<br/><div>';
    str += '<div>';
    if (item[0] == '1')
        str += '<img src="img/succ.png" width="35px" height="30px"/>';
    else
        str += '<img src="img/fail.png" width="35px" height="30px"/>';
    var x0has = false;
    for (var j=2; j<7; j++) {
        var h = item[5][j];
        str += '<img src="img/' + h + '.png" width="30px" height="30px"/>';
        if (h in x0) {
            x0has = true;
        }
        if (result['1'] < 10) {
            hero[h] = 1;
        }
    }
    if (x0has) {
        return '';
    }
    for (var k in x1) {
        var x1has = false;
        for (var j=2; j<7; j++) {
            if (k == item[5][j]) {
                x1has = true;
            }
        }
        if (!x1has) {
            return '';
        }
    }
    str += '<img src="img/vs.png" width="13px" height="17px"/>';
    var y0has = false;
    for (var j=2; j<7; j++) {
        var h = item[6][j];
        str += '<img src="img/' + h + '.png" width="30px" height="30px"/>';
        if (h in y0) {
            y0has = true;
        }
        if (result['1'] < 10) {
            hero[h] = 1;
        }
    }
    if (y0has) {
        return '';
    }
    for (var k in y1) {
        var y1has = false;
        for (var j=2; j<7; j++) {
            if (k == item[6][j]) {
                y1has = true;
            }
        }
        if (!y1has) {
            return '';
        }
    }
    score = item[4];
    if (score > 3000) {
        score = Math.floor((item[4] - 3000) / 30);
    } else if (score > 18000) {
        score = Math.floor(500 + (item[4] - 18000) / 30);
    } else {
    }
    str += item[2];
    str += '<img src="img/clock.png" width="10px" height="10px"/>' + Math.ceil(item[3] / 60);
    str += '<img src="img/star.png" width="10px" height="10px"/>' + score;
    str += '</div>';
    result[succ] += 1;
    time += item[3];
    return str;
}
function writeSummary(file, mo, x0, x1) {
    $.ajaxSettings.async = false;
    $.getJSON(file, "", function(data) {

        player = data[data.length - 1][1];
        result = {"0":0, "1":0};
        time   = 0;

        var topX = 4;
        var strXmap = {};
        for (var i = data.length; i > 0; i--) {
            if (data[i - 1][5].length == 0) {
                continue;
            }
            var x0has = false;
            var x1has = (Object.keys(x1).length == 0);
            var strX = '';
            for (var j = 2; j < 2 + 5; j++) {
                if (j < 2 + topX) {
                    strX += '<img src="img/' + data[i - 1][5][j] + '.png" width="30px" height="30px"/>';
                }
                if (data[i - 1][5][j] in x0) {
                    x0has = true;
                }
                if (data[i - 1][5][j] in x1) {
                    x1has = true;
                }
            }
            if (x0has || (!x1has) || strX == '') {
                continue;
            }
            //console.log('----',data[i - 1][2],strX);
            if (strX in strXmap) {
                strXmap[strX] = strXmap[strX] + 1;
            } else {
                strXmap[strX] = 1;
            }
            var succ = data[i - 1][0];
            result[succ] += 1;
            time += data[i - 1][3];
        }
        var strXarr = Object.keys(strXmap).map(function(key) {
            return [key, strXmap[key]];
        });
        strXarr.sort(function(first, second) {
            return second[1] - first[1];
        });
        var str = '';
        str += '<div>';
        str += strXarr[0][0] + ' ';
        //str += strXarr[0][1];
        str += '<a href="dashen.html?';
        if ('1' in mo) {
            str += 'mo=1&';
        }
        for (var i in x0) {
            str += 'x0=' + i + '&';
        }
        str += 'f=' + file + '"> id: ' + player + '</a> ';
        str += 'rate: ' + Math.floor(result['1']*100/(result['0']+result['1'])) + '% ';
        str += 'time: ' + Math.ceil(time/60/(result['0']+result['1'])) + ' ';
        str += '</div>';
        document.write(str);
    });
}
function writeDocument(file) {
    for (var i = 200; i <= 372; i++) {
        hero[String(i)] = -1;
    }
    hero['229'] = -2;
    hero['235'] = -2;
    hero['239'] = -2;
    hero['240'] = -2;
    hero['255'] = 0;
    hero['288'] = 0;
    hero['330'] = 0;
    hero['341'] = 0;
    hero['352'] = 0;
    hero['356'] = 0;
    hero['357'] = 0;
    hero['362'] = 0;
    hero['363'] = 0;
    hero['366'] = 0;
    $.getJSON(file, "", function(data) {
        var str = '';
        var mo = getUrlParam('mo');
        var x0 = getUrlParam('x0');
        var x1 = getUrlParam('x1');
        var y0 = getUrlParam('y0');
        var y1 = getUrlParam('y1');
        //console.log(mo);
        if ('1' in mo) {
            for (var i = data.length; i > 0; i--) {
                str += getRecord(data[i - 1], '0', 0, x0, x1, y0, y1);
                str += getRecord(data[i - 1], '1', 0, x0, x1, y0, y1);
            }
        } else {
            for (var i = data.length; i > 0; i--) {
                str += getRecord(data[i - 1], '0', 0, x0, x1, y0, y1);
            }
            for (var i = data.length; i > 0; i--) {
                str += getRecord(data[i - 1], '1', 0, x0, x1, y0, y1);
            }
        }
        var hdr = '<br/><div>id: ' + player + '</div>';
        hdr += '<div>rate: ' + Math.floor(result['1']*100/(result['0']+result['1'])) + '% ';
        hdr += 'time: ' + Math.ceil(time/60/(result['0']+result['1'])) + '</div>';
        hdr += '<br/>';
        var ban = '';
        for (var h = 372; h >= 200; h--) {
            if (hero[String(h)] == 0) {
                ban += '<img src="img/' + h + '.png" width="30px" height="30px"/>';
            }
        }
        document.write(ban);
        document.write(hdr);
        document.write(str);
        console.log('done');
    });
}
function process() {
    var db = getUrlParam('db');
    var se = getUrlParam('se');
    var mo = getUrlParam('mo');
    var x0 = getUrlParam('x0');
    var x1 = getUrlParam('x1');
    for (var d in db) {
        var xchg = {};
        for (var server = 10001; server <= 15031; server++) {
            xchg[server] = server;
        }
        xchg[10010] = 10014;
        xchg[10015] = 10016;
        xchg[10031] = 15001;
        xchg[15010] = 15014;
        xchg[15015] = 15023;
        xchg[15025] = 15026;
        xchg[15027] = 15028;
        xchg[15030] = 15031;
        for (var server = 10001; server <= 15031; server++) {
            server = xchg[server];
            var str = '';
            str += '<div>'
            str += '<a href="dashen.html?';
            if ('1' in mo) {
                str += 'mo=1&';
            }
            for (var i in x0) {
                str += 'x0=' + i + '&';
            }
            str += 'se=' + d + '/' + server + '">' + server + '</a>';
            str += '</div>';
            document.write(str);
        }
    }

    for (var s in se) {
        //writeSummary(s + '/001', mo, x0, x1);
        //continue;
        for (var i = 1; i < 10; i++) {
            var f = s + '/00' + i;
            writeSummary(f, mo, x0, x1);
        }
        for (var i = 10; i < 100; i++) {
            var f = s + '/0' + i;
            writeSummary(f, mo, x0, x1);
        }
    }

    var file = getUrlParam('f');
    for (var f in file) {
        writeDocument(f);
    }
}
process()
</script>

<title>dashen</title>
</head>
test
<body>
</body>

</html>	
