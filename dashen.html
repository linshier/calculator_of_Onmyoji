<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Cache-Control" content="no-cache">
<meta http-equiv="Expires" content="0">
<script src="jquery-1.12.4.min.js"></script>
<script>
function getUrlParam(name) {
    var m = {};
    var reg = new RegExp("(^|&)" + name + "=([^&]*)", "g");
    var p = window.location.search.substr(1);
    var r = p.match(reg);
    if (r != null) {
        r.forEach(i => {
            var v = unescape(i).substr(i.indexOf("=") + 1);
            console.log(name, v);
            m[v] = '';
        });
        return m;
    }
    return m;
}
var player = '';
var result = {"0":0, "1":0};
var time = 0;
function getRecord(item, succ, min, x0, x1, y0, y1) {
    if (item[3] == 0 || item[0] != succ || item[4] < min) {
        return '';
    }   
    player = item[1];
    var str = '';
    str += '<br/><div>';
    if (item[0] == '1')
        str += '<img src="img/succ.png" width="35px" height="30px"/>';
    else
        str += '<img src="img/fail.png" width="35px" height="30px"/>';
    var x0has = false;
    for (var j=2; j<7; j++) {
        str += '<img src="img/' + item[5][j] + '.png" width="30px" height="30px"/>';
        if (item[5][j] in x0) {
            x0has = true;
        }
    }
    if (x0has) {
        return '';
    }
    for (var k in x1) {
        var x1has = false;
        for (var j=2; j<7; j++) {
            if (k == item[5][j]) {
                x1has = true;
            }
        }
        if (!x1has) {
            return '';
        }
    }
    str += '<img src="img/vs.png" width="13px" height="17px"/>';
    var y0has = false;
    for (var j=2; j<7; j++) {
        str += '<img src="img/' + item[6][j] + '.png" width="30px" height="30px"/>';
        if (item[6][j] in y0) {
            y0has = true;
        }
    }
    if (y0has) {
        return '';
    }
    for (var k in y1) {
        var y1has = false;
        for (var j=2; j<7; j++) {
            if (k == item[6][j]) {
                y1has = true;
            }
        }
        if (!y1has) {
            return '';
        }
    }
    score = item[4];
    if (score > 3000) {
        score = Math.floor((item[4] - 3000) / 30);
    } else if (score > 18000) {
        score = Math.floor(500 + (item[4] - 18000) / 30);
    } else {
    }
    str += item[2];
    str += '<img src="img/clock.png" width="10px" height="10px"/>' + Math.ceil(item[3] / 60);
    str += '<img src="img/star.png" width="10px" height="10px"/>' + score;
    str += '</div>';
    result[succ] += 1;
    time += item[3];
    return str;
}
function writeSummary(file) {
    $.ajaxSettings.async = false;
    $.getJSON(file, "", function(data) {
        player = data[data.length - 1][1];
        result = {"0":0, "1":0};
        time   = 0;

        var str3map = {};
        for (var i = data.length; i > 0; i--) {
            var succ = data[i - 1][0];
            result[succ] += 1;
            time += data[i - 1][3];

            var str3 = '';
            for (var j=2; j<5; j++) {
                str3 += '<img src="img/' + data[i - 1][5][j] + '.png" width="30px" height="30px"/>';
            }
            if (str3 in str3map) {
                str3map[str3] += 1;
            } else {
                str3map[str3] = 1;
            }
        }
        var str3arr = Object.keys(str3map).map(function(key) {
            return [key, str3map[key]];
        });
        str3arr.sort(function(first, second) {
            return second[1] - first[1];
        });
        //console.log(str3arr[0]);
        var str = '';
        //str += '<br/>'
        str += '<div>';
        str += str3arr[0][0];
        str += str3arr[0][1];
        str += '</div>';
        var hdr = '<br/><div>id: ' + file + '</div>';
        hdr += '<br/><div>rate: ' + Math.floor(result['1']*100/(result['0']+result['1'])) + '% ';
        hdr += 'time: ' + Math.ceil(time/60/(result['0']+result['1'])) + '</div>';
        //document.write(hdr);
        document.write(str);
    });
}
function writeDocument(file) {
    $.getJSON(file, "", function(data) {
        var str = '';
        var mo = getUrlParam('mo');
        var x0 = getUrlParam('x0');
        var x1 = getUrlParam('x1');
        var y0 = getUrlParam('y0');
        var y1 = getUrlParam('y1');
            console.log(mo);
        if ('1' in mo) {
            for (var i = data.length; i > 0; i--) {
                str += getRecord(data[i - 1], '0', 0, x0, x1, y0, y1);
                str += getRecord(data[i - 1], '1', 0, x0, x1, y0, y1);
            }
        } else {
            for (var i = data.length; i > 0; i--) {
                str += getRecord(data[i - 1], '0', 0, x0, x1, y0, y1);
            }
            for (var i = data.length; i > 0; i--) {
                str += getRecord(data[i - 1], '1', 0, x0, x1, y0, y1);
            }
        }
        var hdr = '<br/><div>id: ' + player + '</div>';
        hdr += '<br/><div>rate: ' + Math.floor(result['1']*100/(result['0']+result['1'])) + '% ';
        hdr += 'time: ' + Math.ceil(time/60/(result['0']+result['1'])) + '</div>';
        document.write(hdr);
        document.write(str);
        console.log('done');
    });
}
var dir = getUrlParam('d');
for (var d in dir) {
    for (var i = 1; i < 10; i++) {
        var f = d + '/00' + i;
        writeSummary(f);
    }
    for (var i = 10; i < 100; i++) {
        var f = d + '/0' + i;
        writeSummary(f);
    }
}
var file = getUrlParam('f');
for (var f in file) {
    writeDocument(f);
}
</script>

<title>dashen</title>
</head>
test
<body>
</body>

</html>	
